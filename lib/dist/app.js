// Generated by CoffeeScript 2.7.0
var MongoDoc, Seq, _, app, express, logger, modules, xplore, xpressBodyParser, xpressCompress, xpressJade, xpressLogger, xpressStatic;

modules = require('modules');

express = require('express');

MongoDoc = require('macmodel');

Seq = require('seq');

_ = require('underscore');

xpressLogger = require('morgan');

xpressBodyParser = require('body-parser');

xpressJade = require('pug');

xpressCompress = require('compression');

xpressStatic = require('serve-static');

logger = console;

app = express();

app.set('view engine', 'pug');

app.set('views', `${__dirname}/../../views`);

app.set('view options', {
  layout: true,
  pretty: true
});

app.use(xpressCompress()).use('/assets', xpressStatic(`${__dirname}/../../static/dist`)).use(xpressLogger()).use(xpressBodyParser());

xplore = {
  start: function(mongoConfig, xploreConfig, fn) {
    var cache, cacheConfig, handlers, port;
    logger.info("Will start Xplore");
    ({port, logger, cache} = xploreConfig);
    port = port || 4280;
    logger = logger || console;
    cacheConfig = cache || [];
    logger.debug(`Modules: ${_.keys(modules)}`);
    handlers = require('handlers');
    if (mongoConfig.databases === void 0) {
      mongoConfig.databases = {};
    }
    mongoConfig.databases.xplore = {
      "report": []
    };
    return Seq().seq(function() {
      return MongoDoc.db.initialize(mongoConfig, logger, this);
    }).seq(function() {
      logger.debug(`Xplore will use MongoDoc.db.report ${MongoDoc.db.report}`);
      handlers.main(app, cacheConfig);
      app.listen(port);
      logger.info(`Xplore server listening on port ${port}`);
      return typeof fn === "function" ? fn(null) : void 0;
    }).catch(function(boo) {
      logger.error(boo);
      return typeof fn === "function" ? fn(boo) : void 0;
    });
  }
};

module.exports = xplore;
