// Generated by CoffeeScript 2.7.0
  /**
  * Modules dependencies
   */
var _, dirExclude, dirInclude, fs, jsExclude, jsInclude, path,
  indexOf = [].indexOf;

fs = require('fs');

_ = require('underscore');

path = require('path');

jsInclude = /(^[^\.].*)\.js/;

jsExclude = /index.js|.*skip.js/;

dirInclude = /^[^\.].*/;

dirExclude = /\..*/;

module.exports = {
  /**
  * Recursively scans the directory for module files & module directories
  * @param {String} directory path
  * @param {Hash} {include: []} - include non-module files as buffers (e.g ['csv'] to include csv files)
  * @returns {Array} require-ready strings, eg ['./thismodule', './thatmoduledir']
  * The returned array is sorted consistently with module loading orders, aka:
  * 	- modules in directories closer to the root take precedence (loaded before subdirectories)
  *		- within the same directory modules are loaded in alphabetical order
   */
  scan: function(dirname, options) {
    var ls, modules;
    ls = fs.readdirSync(dirname);
    // Load files first
    // Sort in ascending order (filename), files first, directories last
    ls = ls.sort(function(path1, path2) {
      var isFilePath1, isFilePath2;
      isFilePath1 = fs.statSync(path.join(dirname, path1)).isFile();
      isFilePath2 = fs.statSync(path.join(dirname, path2)).isFile();
      if (isFilePath1 && !isFilePath2) {
        return -1;
      } else if (isFilePath2 && !isFilePath1) {
        return 1;
      } else if (path1 < path2) {
        return -1;
      } else {
        return 1;
      }
    });
    
    //Filters out non-module files and map the result to require-ready strings
    return modules = _(ls).chain().filter(function(name) {
      var absoluteRef, include, isDataFile, isDir, isFile, isModuleDir, isModuleFile, ref, ref1;
      absoluteRef = path.join(dirname, name);
      isFile = fs.statSync(absoluteRef).isFile();
      isModuleFile = isFile && (name.match(jsInclude) && !name.match(jsExclude));
      isDataFile = false;
      if (options != null ? (ref = options.include) != null ? ref.length : void 0 : void 0) {
        isDataFile = isFile && !isModuleFile && (ref1 = name.split('.').pop(), indexOf.call(options.include, ref1) >= 0);
      }
      isDir = fs.statSync(absoluteRef).isDirectory() && name.match(dirInclude) && !name.match(dirExclude);
      isModuleDir = isDir && (_(fs.readdirSync(absoluteRef)).indexOf('index.js') > -1);
      include = isModuleFile || isDataFile || isModuleDir;
      //console.log("module scan: #{name} #{if include then 'added' else 'excluded'}")
      return include;
    }).map(function(name) {
      if (name.match(jsInclude)) {
        return path.join(dirname, jsInclude.exec(name)[1]);
      } else {
        return path.join(dirname, name);
      }
    }).value();
  }
};
